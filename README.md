# Instructor for PHP

Structured data extraction in PHP, powered by LLMs. Designed for simplicity, transparency, and control.

> **NOTE: This is work in progress.**
> - The code is still in development and not fully working.
> - Library API is likely to change.
> - Docs may not reflect actual state of the code.


## What is Instructor?

Instructor is a library that allows you to extract structured, validated data from unstructured text or OpenAI style chat sequence arrays. It is powered by Large Language Models (LLMs).

Instructor for PHP is inspired by the [Instructor](https://jxnl.github.io/instructor/) library for Python created by [Jason Liu](https://twitter.com/jxnlco).


## Instructor in Other Languages

Check out implementations in other languages below:

- [Python](https://www.github.com/jxnl/instructor) (original)
- [Javascript](https://github.com/instructor-ai/instructor-js) (port)
- [Elixir](https://github.com/thmsmlr/instructor_ex/) (port)

If you want to port Instructor to another language, please reach out to us on [Twitter](https://twitter.com/jxnlco) we'd love to help you get started!


## How Instructor Enhances Your Workflow

Instructor introduces three key enhancements compared to direct API usage.

### Response Model

You just specify a PHP class to extract data into via the 'magic' of LLM chat completion. And that's it.

Instructor reduces brittleness of the code extracting the information from textual data by leveraging structured LLM responses.

Instructor helps you write simpler, easier to understand code - you no longer have to define lengthy function call definitions or write code for assigning returned JSON into target data objects.

### Validation

Response model generated by LLM can be automatically validated, following set of rules. Currently, Instructor supports only Symfony validation.

You can also provide a context object to use enhanced validator capabilities.

### Max Retries

You can set the number of retry attempts for requests.

Instructor will repeat requests in case of validation error (or API failure) up to the specified number of times.


## Get Started

Installing Instructor is simple. Run following command in your terminal and you're on your way to a smoother data handling experience!

```bash
composer install cognesy/instructor
```


## Usage


### Basic example

This is a simple example demonstrating how Instructor retrieves structured information from provided text (or chat message sequence).

Response model class is a plain PHP class with typehints specifying the types of fields of the object.

```php
    use Cognesy/Instructor;
    use OpenAI;

    // Step 1: Define target data structure(s)
    class Person {
        public string $name;
        public int $age;
    }

    // Step 2: Provide content to process
    $text = "His name is Jason and he is 28 years old.";

    // Step 3: Use Instructor to run LLM inference
    $person = (new Instructor)->chat(
        messages: [['role' => 'user', 'content' => $text]],
        responseModel: Person::class,
    ); // default OpenAI client is used

    // Step 4: Work with structured response data
    assert($person instanceof Person); // true
    assert($person->name === 'Jason'); // true
    assert($person->age === 28); // true

    echo $person->name; // Jason
    echo $person->age; // 28
    
    var_dump($person);
    // Person {
    //     name: "Jason",
    //     age: 28
    // }    
```
> **NOTE:** Currently, Instructor only supports classes / objects as response models. In case you want to extract simple types or arrays, you need to wrap them in a class. 


### Type Hints

Use PHP type hints to specify the type of extracted data. Use nullable types to indicate that a field are optional.

```php
    class Person {
        public string $name;
        public ?int $age;
        public Address $address;
    }
```

### DocBlock type hints

You can also use PHP DocBlock style comments to specify the type of extracted data. This is useful when you want to specify property types for LLM, but can't or don't want to enforce type at the code level.

```php
    class Person {
        /** @var string */
        public $name;
        /** @var int */
        public $age;
        /** @var Address $address person's address */
        public $address;
    }
```

See PHPDoc documentation for more details on DocBlock: https://docs.phpdoc.org/3.0/guide/getting-started/what-is-a-docblock.html#what-is-a-docblock


### Typed Collections / Arrays

PHP currently [does not support generics](https://wiki.php.net/rfc/generics) or typehints to specify array element types.

Use PHP DocBlock style comments to specify the type of array elements.

```php
    class Person {
        // ...
    }

    class Event {
        // ...
        /** @var Person[] list of extracted event participants */
        public array $participants;
        // ...
    }
```


### Complex data extraction

Instructor can retrieve complex data structures from text. Your response model can contain nested objects, arrays, and enums.

```php
    use Cognesy/Instructor;
    use OpenAI;
    
    // define a data structures to extract data into
    class Person {
        public string $name;
        public int $age;
        public string $profession;
        /** @var Skill[] */
        public array $skills;
    }

    class Skill {
        public string $name;
        public SkillType $type;
    }

    enum SkillType {
        case Technical = 'technical';
        case Other = 'other';
    }
    
    $text = "Alex is 25 years old software engineer, who knows PHP, Python and can play the guitar.";

    $person = (new Instructor)->chat(
        messages: [['role' => 'user', 'content' => $text]],
        responseModel: Person::class,
        client: OpenAI::client($yourApiKey),
    ); // client is passed explicitly, can specify eg. different base URL
    
    // data is extracted into an object of given class
    assert($person instanceof Person); // true
    
    // you can access object's extracted property values
    echo $person->name; // Alex
    echo $person->age; // 25
    echo $person->profession; // software engineer
    echo $person->skills[0]->name; // PHP
    echo $person->skills[0]->type; // SkillType::Technical
    // ...
    
    var_dump($person);
    // Person {
    //     name: "Alex",
    //     age: 25,
    //     profession: "software engineer",
    //     skills: [
    //         Skill {
    //              name: "PHP",
    //              type: SkillType::Technical,
    //         },
    //         Skill {
    //              name: "Python",
    //              type: SkillType::Technical,
    //         },
    //         Skill {
    //              name: "guitar",
    //              type: SkillType::Other
    //         },
    //     ]
    // }
```

### Specifying OpenAI / LLM model and other options

You can specify model and other options that will be passed to OpenAI / LLM endpoint.

For more details on options available - see [OpenAI PHP client](https://github.com/openai-php/client).

```php
    $person = (new Instructor)->chat(
        messages: [['role' => 'user', 'content' => $text]],
        responseModel: Person::class,
        model: 'gpt-3.5-turbo',
        options: ['temperature' => 0.0],
        client: OpenAI::client($yourApiKey),
    ); // client is passed explicitly, can specify eg. different base URL
```

### Using DocBlocks as Additional Instructions for LLM

You can use PHP DocBlocks (/** */) to provide additional instructions for LLM at class or field level, for example to clarify what you expect or how LLM should process your data.

Instructor extracts PHP DocBlocks comments from class and property defined and includes them in specification of response model sent to LLM.  

Using PHP DocBlocks instructions is not required, but sometimes you may want to clarify your intentions to improve LLM's inference results.

```php
    /**
     * Represents a skill of a person and context in which it was mentioned. 
     */
    class Skill {
        public string $name;
        /** @var SkillType $type type of the skill, derived from the description and context */
        public SkillType $type;
        /** Directly quoted, full sentence mentioning person's skill */
        public string $context;
    }
```


### Validation

```php
// TODO: example
```

## Additional Notes

PHP ecosystem does not (yet) have a strong equivalent of [Pydantic](https://pydantic.dev/), which is at the core of Instructor for Python.

Instructor for PHP leverages
 - base capabilities of PHP type system and reflection,
 - PHP DocBlock type hinting conventions,
 - Symfony serialization and validation capabilities
to provide an essential functionality we needed here.

## Dependencies

 - [Symfony Validation](https://symfony.com/doc/current/validation.html)
 - [Symfony Serializer](https://symfony.com/doc/current/components/serializer.html)
 - [Symfony PropertyInfo](https://symfony.com/doc/current/components/property_info.html)

## TODOs

- [ ] Validation
- [ ] Retrying / error handling
- [ ] Tests
- [ ] Better comments in codebase
- [ ] Public vs protected / private fields - document behavior
- [ ] Support for iterables / collections (via ArrayAccess, Iterator)
- [ ] Async
- [ ] Open source LLM support
- [ ] Logging


## Contributing

If you want to help, check out some of the issues. They could be anything from code improvements, a guest blog post, or a new cookbook.


## License

This project is licensed under the terms of the MIT License.
